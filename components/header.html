<header class="home-header fixed-top d-flex align-items-center">
  <div class="container-fluid px-4 d-flex justify-content-between align-items-center position-relative">
    <!-- Logo và Menu Button -->
    <div class="d-flex align-items-center">
      <button class="btn border-0 text-white d-md-none me-3 p-0" id="menuToggle">
        <i class="fa-solid fa-bars fs-4"></i>
      </button>

      <a href="index.html" class="logo-link text-decoration-none d-flex align-items-center gap-2">
        <img src="assets/images/VitaFlix.png" alt="Logo" class="logo-img" 
             onerror="this.style.display='none'" />
        <h1 class="logo-text m-0">VitaFlix</h1>
      </a>
    </div>

    <!-- Desktop Navigation -->
    <nav class="d-none d-md-block position-absolute start-50 translate-middle-x">
      <ul class="list-unstyled d-flex align-items-center gap-1 m-0">
        <li>
          <a href="index.html" class="nav-link-custom">Trang chủ</a>
        </li>

        <!-- DROPDOWN THỂ LOẠI -->
        <li class="nav-item has-dropdown">
          <div class="dropdown-trigger">
            <a href="#" class="nav-link-custom">
              Thể loại <i class="fa-solid fa-caret-down"></i>
            </a>
          </div>

          <div class="dropdown-content">
            <p class="dropdown-title">Chọn Thể Loại</p>
            <div class="dropdown-list">
              <a href="categorize-movie.html?type=genre&genre=hanh-dong" class="dropdown-item">Hành Động</a>
              <a href="categorize-movie.html?type=genre&genre=kinh-di" class="dropdown-item">Kinh Dị</a>
              <a href="categorize-movie.html?type=genre&genre=hai-huoc" class="dropdown-item">Hài Hước</a>
              <a href="categorize-movie.html?type=genre&genre=tinh-cam" class="dropdown-item">Tình Cảm</a>
              <a href="categorize-movie.html?type=genre&genre=khoa-hoc-vien-tuong" class="dropdown-item">Khoa Học Viễn Tưởng</a>
              <a href="categorize-movie.html?type=genre&genre=phieu-luu" class="dropdown-item">Phiêu Lưu</a>
              <a href="categorize-movie.html?type=genre&genre=than-thoai" class="dropdown-item">Thần Thoại</a>
              <a href="categorize-movie.html?type=genre&genre=tai-lieu" class="dropdown-item">Tài Liệu</a>
            </div>
          </div>
        </li>

        <!-- DROPDOWN PHIM BỘ -->
        <li class="nav-item has-dropdown" data-list-type="series">
          <a href="#" class="filter-btn" data-filter="series">Phim Bộ <i class="fa-solid fa-caret-down"></i></a>
          <div class="dropdown-content js-series-dropdown">
            <p class="dropdown-title">Phim Bộ Nổi Bật</p>
            <div class="dropdown-list"></div>
            <a href="categorize-movie.html?type=series" class="dropdown-more">Xem Thêm Phim Bộ...</a>
          </div>
        </li>

        <!-- DROPDOWN PHIM LẺ -->
        <li class="nav-item has-dropdown" data-list-type="single">
          <a href="#" class="filter-btn" data-filter="single">Phim Lẻ <i class="fa-solid fa-caret-down"></i></a>
          <div class="dropdown-content js-single-dropdown">
            <p class="dropdown-title">Phim Lẻ Nổi Bật</p>
            <div class="dropdown-list"></div>
            <a href="categorize-movie.html?type=single" class="dropdown-more">Xem Thêm Phim Lẻ...</a>
          </div>
        </li>

        <!-- DROPDOWN QUỐC GIA -->
        <li class="nav-item has-dropdown">
          <a href="#" class="nav-link-custom">
            Quốc gia <i class="fa-solid fa-caret-down"></i>
          </a>
          <div class="dropdown-content">
            <p class="dropdown-title">Chọn Quốc Gia</p>
            <div class="dropdown-list">
              <a href="categorize-movie.html?type=country&country=han-quoc" class="dropdown-item">Hàn Quốc</a>
              <a href="categorize-movie.html?type=country&country=trung-quoc" class="dropdown-item">Trung Quốc</a>
              <a href="categorize-movie.html?type=country&country=thai-lan" class="dropdown-item">Thái Lan</a>
              <a href="categorize-movie.html?type=country&country=my" class="dropdown-item">Mỹ</a>
              <a href="categorize-movie.html?type=country&country=nhat-ban" class="dropdown-item">Nhật Bản</a>
              <a href="categorize-movie.html?type=country&country=viet-nam" class="dropdown-item">Việt Nam</a>
              <a href="categorize-movie.html?type=country&country=an-do" class="dropdown-item">Ấn Độ</a>
              <a href="categorize-movie.html?type=country&country=khac" class="dropdown-item">Khác</a>
            </div>
          </div>
        </li>
      </ul>
    </nav>

    <!-- Search và User Profile -->
    <div class="d-flex align-items-center gap-3">
      <div class="search-box d-none d-sm-flex align-items-center position-relative">
        <input type="text" id="searchInput" class="form-control shadow-none" 
               placeholder="Tìm kiếm phim..." autocomplete="off" />
        <i class="fa-solid fa-magnifying-glass text-white pe-3 search-icon"></i>

        <div class="search-results-dropdown" id="searchResults" style="display: none;">
          <div class="search-results-content"></div>
        </div>
      </div>

      <i class="fa-solid fa-magnifying-glass d-sm-none fs-5 cursor-pointer text-white"></i>

      <div class="user-profile-wrapper">
        <div class="user-profile" id="userProfileIcon">
          <i class="fa-solid fa-user fs-5 text-white" id="defaultUserIcon"></i>
          <img id="headerAvatar" class="header-avatar d-none" />
        </div>

        <div class="user-info-dropdown" id="userInfoDropdown">
          <div class="dropdown-header d-flex align-items-center mb-2">
            <img id="dropdownAvatar" class="dropdown-avatar me-2 d-none" alt="Avatar" />
            <i class="fa-solid fa-user fs-4 me-2" id="dropdownDefaultIconInDropdown"></i>
            <p class="dropdown-username m-0">
              Xin chào, <span id="displayUsername">Tên Người Dùng</span>!
            </p>
          </div>
          <hr>
          <a href="components/profile.html" class="dropdown-link">
            <i class="fa-solid fa-gear"></i> Quản lý Tài khoản
          </a>
          <button id="logoutBtn" class="dropdown-link logout-button">
            <i class="fa-solid fa-right-from-bracket"></i> Đăng xuất
          </button>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Mobile Menu -->
<div class="mobile-menu">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="logo-text m-0">VitaFlix</h3>
    <button class="btn text-white border-0" id="closeMobileMenu">
      <i class="fa-solid fa-xmark fs-4"></i>
    </button>
  </div>
  <ul class="list-unstyled d-flex flex-column gap-3">
    <li>
      <a href="index.html" class="text-white text-decoration-none fs-5 mobile-nav-link">
        <i class="fa-solid fa-house me-2"></i> Trang chủ
      </a>
    </li>

    <li>
      <div class="mobile-dropdown-trigger text-white-50 fs-5">
        Thể loại <i class="fa-solid fa-caret-down"></i>
      </div>
      <div class="mobile-dropdown-content">
        <a href="categorize-movie.html?type=genre&genre=hanh-dong">Hành Động</a>
        <a href="categorize-movie.html?type=genre&genre=kinh-di">Kinh Dị</a>
        <a href="categorize-movie.html?type=genre&genre=hai-huoc">Hài Hước</a>
        <a href="categorize-movie.html?type=genre&genre=tinh-cam">Tình Cảm</a>
      </div>
    </li>

    <li>
      <a href="categorize-movie.html?type=single" class="text-white-50 text-decoration-none fs-5">
        Phim lẻ
      </a>
    </li>
    <li>
      <a href="categorize-movie.html?type=series" class="text-white-50 text-decoration-none fs-5">
        Phim bộ
      </a>
    </li>

    <li>
      <div class="mobile-dropdown-trigger text-white-50 fs-5">
        Quốc gia <i class="fa-solid fa-caret-down"></i>
      </div>
      <div class="mobile-dropdown-content">
        <a href="categorize-movie.html?type=country&country=han-quoc">Hàn Quốc</a>
        <a href="categorize-movie.html?type=country&country=trung-quoc">Trung Quốc</a>
        <a href="categorize-movie.html?type=country&country=thai-lan">Thái Lan</a>
        <a href="categorize-movie.html?type=country&country=my">Mỹ</a>
        <a href="categorize-movie.html?type=country&country=nhat-ban">Nhật Bản</a>
      </div>
    </li>
  </ul>
</div>
<div class="overlay"></div>

<!-- SCRIPT ĐƯỢC NHÚNG TRỰC TIẾP -->
<script>
  // Mobile Menu Toggle
  const menuBtn = document.querySelector("#menuToggle");
  const mobileMenu = document.querySelector(".mobile-menu");
  const overlay = document.querySelector(".overlay");
  const closeMobileMenuBtn = document.querySelector("#closeMobileMenu");

  if (menuBtn) {
    menuBtn.addEventListener("click", () => {
      mobileMenu.classList.add("active");
      overlay.classList.add("active");
      document.body.style.overflow = "hidden";
    });
  }

  if (overlay) {
    overlay.addEventListener("click", closeMenu);
  }

  if (closeMobileMenuBtn) {
    closeMobileMenuBtn.addEventListener("click", closeMenu);
  }

  function closeMenu() {
    if (mobileMenu) mobileMenu.classList.remove("active");
    if (overlay) overlay.classList.remove("active");
    document.body.style.overflow = "";
  }

  // Mobile dropdown toggle
  document.querySelectorAll(".mobile-dropdown-trigger").forEach((trigger) => {
    trigger.addEventListener("click", function () {
      const content = this.nextElementSibling;
      const isActive = content.classList.contains("active");

      document.querySelectorAll(".mobile-dropdown-content").forEach((item) => {
        item.classList.remove("active");
      });

      if (!isActive) {
        content.classList.add("active");
      }
    });
  });

  // User authentication UI
  (function () {
    const USER_KEY = "vitaflix_current_user";
    const displayUsernameSpan = document.querySelector("#displayUsername");
    const userWrapper = document.querySelector(".user-profile-wrapper");
    const headerAvatar = document.querySelector("#headerAvatar");
    const defaultIcon = document.querySelector("#defaultUserIcon");
    const dropdown = document.querySelector("#userInfoDropdown");

    function updateUserUI() {
      let user = null;
      try {
        user = JSON.parse(localStorage.getItem(USER_KEY));
      } catch (e) {
        user = null;
      }

      if (user && user.username) {
        if (displayUsernameSpan) displayUsernameSpan.textContent = user.username;
        if (userWrapper) userWrapper.style.display = "";

        const hasAvatar = user.avatar && user.avatar.trim() !== "";
        if (hasAvatar) {
          if (headerAvatar) {
            headerAvatar.src = user.avatar;
            headerAvatar.classList.remove("d-none");
          }
          if (defaultIcon) defaultIcon.classList.add("d-none");
        } else {
          if (defaultIcon) defaultIcon.classList.remove("d-none");
          if (headerAvatar) headerAvatar.classList.add("d-none");
        }
      } else {
        if (displayUsernameSpan) displayUsernameSpan.textContent = "Khách";
        if (userWrapper) userWrapper.style.display = "";

        if (defaultIcon) defaultIcon.classList.remove("d-none");
        if (headerAvatar) headerAvatar.classList.add("d-none");
      }
    }

    window.addEventListener("load", updateUserUI);
    window.addEventListener("storage", function (e) {
      if (e.key === USER_KEY) updateUserUI();
    });

    // Dropdown toggle
    document.addEventListener("click", function (e) {
      if (!dropdown) return;

      const clickedIcon = e.target.closest("#userProfileIcon");
      if (clickedIcon) {
        e.stopPropagation();
        const currentUser = localStorage.getItem(USER_KEY);
        if (!currentUser) {
            window.location.href = "login.html"; 
            return;
        }

        dropdown.classList.toggle("active");
        dropdown.style.display = dropdown.classList.contains("active") ? "block" : "none";
        return;
      }

      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove("active");
        dropdown.style.display = "none";
      }
    });

    // Logout
    document.addEventListener("click", function (e) {
      const logoutBtn = e.target.closest("#logoutBtn");
      if (!logoutBtn) return;
      localStorage.removeItem(USER_KEY);
      window.location.href = "./login.html";
    });
  })();
</script>