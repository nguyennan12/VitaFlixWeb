<header class="home-header fixed-top d-flex align-items-center">
  <div class="container-fluid px-4 d-flex justify-content-between align-items-center position-relative">
    <!-- Logo và Menu Button -->
    <div class="d-flex align-items-center">
      <button class="btn border-0 text-white d-md-none me-3 p-0" id="menuToggle">
        <i class="fa-solid fa-bars fs-4"></i>
      </button>

      <a href="/index.html" class="logo-link text-decoration-none d-flex align-items-center gap-2">
        <img src="/assets/images/VitaFlix.png" alt="Logo" class="logo-img" />
        <h1 class="logo-text m-0">VitaFlix</h1>
      </a>
    </div>

    <!-- Desktop Navigation -->
    <nav class="d-none d-md-block position-absolute start-50 translate-middle-x">
      <ul class="list-unstyled d-flex align-items-center gap-1 m-0">
        <li>
          <a href="/index.html" class="nav-link-custom">Trang chủ</a>
        </li>
        <!--         
        <li>
          <a href="#" class="nav-link-custom" data-page="category">Chủ đề</a>
        </li> -->

        <!-- DROPDOWN THỂ LOẠI -->
        <li class="nav-item has-dropdown">
          <div class="dropdown-trigger">
            <a href="#" class="nav-link-custom">
              Thể loại <i class="fa-solid fa-caret-down"></i>
            </a>
          </div>

          <div class="dropdown-content">
            <p class="dropdown-title">Chọn Thể Loại</p>
            <div class="dropdown-list">
              <a href="/categorize-movie.html?type=genre&genre=hanh-dong" class="dropdown-item">Hành Động</a>
              <a href="/categorize-movie.html?type=genre&genre=kinh-di" class="dropdown-item">Kinh Dị</a>
              <a href="/categorize-movie.html?type=genre&genre=hai-huoc" class="dropdown-item">Hài Hước</a>
              <a href="/categorize-movie.html?type=genre&genre=tinh-cam" class="dropdown-item">Tình Cảm</a>
              <a href="/categorize-movie.html?type=genre&genre=khoa-hoc-vien-tuong" class="dropdown-item">Khoa Học Viễn
                Tưởng</a>
              <a href="/categorize-movie.html?type=genre&genre=phieu-luu" class="dropdown-item">Phiêu Lưu</a>
              <a href="/categorize-movie.html?type=genre&genre=than-thoai" class="dropdown-item">Thần Thoại</a>
              <a href="/categorize-movie.html?type=genre&genre=tai-lieu" class="dropdown-item">Tài Liệu</a>
            </div>
          </div>
        </li>

        <!-- DROPDOWN PHIM BỘ -->
        <li class="nav-item has-dropdown" data-list-type="series">
          <a href="#" class="filter-btn" data-filter="series">Phim Bộ <i class="fa-solid fa-caret-down"></i></a>
          <div class="dropdown-content js-series-dropdown">
            <p class="dropdown-title">Phim Bộ Nổi Bật</p>
            <div class="dropdown-list"></div>
            <a href="/categorize-movie.html?type=series" class="dropdown-more">Xem Thêm Phim Bộ...</a>
          </div>
        </li>

        <!-- DROPDOWN PHIM LẺ -->
        <li class="nav-item has-dropdown" data-list-type="single">
          <a href="#" class="filter-btn" data-filter="single">Phim Lẻ <i class="fa-solid fa-caret-down"></i></a>
          <div class="dropdown-content js-single-dropdown">
            <p class="dropdown-title">Phim Lẻ Nổi Bật</p>
            <div class="dropdown-list"></div>
            <a href="/categorize-movie.html?type=single" class="dropdown-more">Xem Thêm Phim Lẻ...</a>
          </div>
        </li>

        <!-- DROPDOWN QUỐC GIA -->
        <li class="nav-item has-dropdown">
          <a href="#" class="nav-link-custom">
            Quốc gia <i class="fa-solid fa-caret-down"></i>
          </a>
          <div class="dropdown-content">
            <p class="dropdown-title">Chọn Quốc Gia</p>
            <div class="dropdown-list">
              <a href="/categorize-movie.html?type=country&country=han-quoc" class="dropdown-item">Hàn Quốc</a>
              <a href="/categorize-movie.html?type=country&country=trung-quoc" class="dropdown-item">Trung Quốc</a>
              <a href="/categorize-movie.html?type=country&country=thai-lan" class="dropdown-item">Thái Lan</a>
              <a href="/categorize-movie.html?type=country&country=my" class="dropdown-item">Mỹ</a>
              <a href="/categorize-movie.html?type=country&country=nhat-ban" class="dropdown-item">Nhật Bản</a>
              <a href="/categorize-movie.html?type=country&country=viet-nam" class="dropdown-item">Việt Nam</a>
              <a href="/categorize-movie.html?type=country&country=an-do" class="dropdown-item">Ấn Độ</a>
              <a href="/categorize-movie.html?type=country&country=khac" class="dropdown-item">Khác</a>
            </div>
          </div>
        </li>
      </ul>
    </nav>

    <!-- Search và User Profile -->
    <div class="d-flex align-items-center gap-3">
      <div class="search-box d-none d-sm-flex align-items-center position-relative">
        <input type="text" id="searchInput" class="form-control shadow-none" placeholder="Tìm kiếm phim..."
          autocomplete="off" />
        <i class="fa-solid fa-magnifying-glass text-white pe-3 search-icon"></i>

        <!-- Dropdown kết quả tìm kiếm -->
        <div class="search-results-dropdown" id="searchResults" style="display: none;">
          <div class="search-results-content"></div>
        </div>
      </div>

      <i class="fa-solid fa-magnifying-glass d-sm-none fs-5 cursor-pointer text-white"></i>

      <div class="user-profile-wrapper">
        <div class="user-profile" id="userProfileIcon">
          <i class="fa-solid fa-user fs-5 text-white" id="defaultUserIcon"></i>
          <img id="headerAvatar" class="header-avatar d-none" />
        </div>

        <div class="user-info-dropdown" id="userInfoDropdown">
          <div class="dropdown-header d-flex align-items-center mb-2">
            <img id="dropdownAvatar" class="dropdown-avatar me-2 d-none" alt="Avatar" />
            <i class="fa-solid fa-user fs-4 me-2" id="dropdownDefaultIconInDropdown"></i>
            <p class="dropdown-username m-0">
              Xin chào, <span id="displayUsername">Tên Người Dùng</span>!
            </p>
          </div>
          <hr>
          <a href="/components/profile.html" class="dropdown-link"> <i class="fa-solid fa-gear"></i> Quản lý Tài
            khoản </a>
          <button id="logoutBtn" class="dropdown-link logout-button"> <i class="fa-solid fa-right-from-bracket"></i>
            Đăng xuất </button>
        </div>
      </div>
    </div>
</header>

<!-- Mobile Menu -->
<div class="mobile-menu">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="logo-text m-0">VitaFlix</h3>
    <button class="btn text-white border-0" id="closeMobileMenu">
      <i class="fa-solid fa-xmark fs-4"></i>
    </button>
  </div>
  <ul class="list-unstyled d-flex flex-column gap-3">
    <li>
      <a href="/index.html" class="text-white text-decoration-none fs-5 mobile-nav-link">
        <a href="/index.html" class="text-white text-decoration-none fs-5 mobile-nav-link">
          <i class="fa-solid fa-house me-2"></i> Trang chủ
        </a>
    </li>
    <!-- <li>
      <a href="#" class="text-white-50 text-decoration-none fs-5 mobile-nav-link" data-page="category">
        Chủ đề
      </a>
    </li> -->

    <!-- Mobile Thể Loại -->
    <li>
      <div class="mobile-dropdown-trigger text-white-50 fs-5">
        Thể loại <i class="fa-solid fa-caret-down"></i>
      </div>
      <div class="mobile-dropdown-content">
        <a href="/categorize-movie.html?type=genre&genre=hanh-dong">Hành Động</a>
        <a href="/categorize-movie.html?type=genre&genre=kinh-di">Kinh Dị</a>
        <a href="/categorize-movie.html?type=genre&genre=hai-huoc">Hài Hước</a>
        <a href="/categorize-movie.html?type=genre&genre=tinh-cam">Tình Cảm</a>
        <a href="/categorize-movie.html?type=genre&genre=khoa-hoc-vien-tuong">Khoa Học Viễn Tưởng</a>
      </div>
    </li>

    <li>
      <a href="/categorize-movie.html?type=single" class="text-white-50 text-decoration-none fs-5">
        Phim lẻ
      </a>
    </li>
    <li>
      <a href="/categorize-movie.html?type=series" class="text-white-50 text-decoration-none fs-5">
        Phim bộ
      </a>
    </li>

    <!-- Mobile Quốc Gia -->
    <li>
      <div class="mobile-dropdown-trigger text-white-50 fs-5">
        Quốc gia <i class="fa-solid fa-caret-down"></i>
      </div>
      <div class="mobile-dropdown-content">
        <a href="/categorize-movie.html?type=country&country=han-quoc">Hàn Quốc</a>
        <a href="/categorize-movie.html?type=country&country=trung-quoc">Trung Quốc</a>
        <a href="/categorize-movie.html?type=country&country=thai-lan">Thái Lan</a>
        <a href="/categorize-movie.html?type=country&country=my">Mỹ</a>
        <a href="/categorize-movie.html?type=country&country=nhat-ban">Nhật Bản</a>
      </div>
    </li>
  </ul>
</div>
<div class="overlay"></div>

<style>
  /* Dropdown styles */
  .dropdown-item {
    display: block;
    padding: 8px 12px;
    color: #fff;
    text-decoration: none;
    transition: background-color 0.3s;
  }

  .dropdown-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: #8fd3dd;
  }

  /* Mobile dropdown styles */
  .mobile-dropdown-trigger {
    cursor: pointer;
    padding: 8px 0;
    user-select: none;
  }

  .mobile-dropdown-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding-left: 20px;
  }

  .mobile-dropdown-content.active {
    max-height: 500px;
  }

  .mobile-dropdown-content a {
    display: block;
    padding: 8px 0;
    color: rgba(255, 255, 255, 0.7);
    text-decoration: none;
    font-size: 0.9rem;
  }

  .mobile-dropdown-content a:hover {
    color: #8fd3dd;
  }
</style>

<script>
  // Mobile Menu Toggle
  const menuBtn = document.querySelector("#menuToggle");
  const mobileMenu = document.querySelector(".mobile-menu");
  const overlay = document.querySelector(".overlay");
  const closeMobileMenuBtn = document.querySelector("#closeMobileMenu");

  // Mở menu
  if (menuBtn) {
    menuBtn.addEventListener("click", () => {
      mobileMenu.classList.add("active");
      overlay.classList.add("active");
      document.body.style.overflow = "hidden";
    });
  }

  // Đóng menu khi click overlay
  if (overlay) {
    overlay.addEventListener("click", closeMenu);
  }

  // Đóng menu khi click nút X
  if (closeMobileMenuBtn) {
    closeMobileMenuBtn.addEventListener("click", closeMenu);
  }

  // Hàm đóng menu
  function closeMenu() {
    if (mobileMenu) mobileMenu.classList.remove("active");
    if (overlay) overlay.classList.remove("active");
    document.body.style.overflow = "";
  }

  // Mobile dropdown toggle
  document.querySelectorAll(".mobile-dropdown-trigger").forEach((trigger) => {
    trigger.addEventListener("click", function () {
      const content = this.nextElementSibling;
      const isActive = content.classList.contains("active");

      // Đóng tất cả dropdown khác
      document.querySelectorAll(".mobile-dropdown-content").forEach((item) => {
        item.classList.remove("active");
      });

      // Toggle dropdown hiện tại
      if (!isActive) {
        content.classList.add("active");
      }
    });
  });

  // Xử lý navigation cho desktop
  document.querySelectorAll(".nav-link-custom").forEach((link) => {
    link.addEventListener("click", handleNavClick);
  });

  // Xử lý navigation cho mobile
  document.querySelectorAll(".mobile-nav-link").forEach((link) => {
    link.addEventListener("click", (e) => {
      handleNavClick(e);
      closeMenu();
    });
  });

  // Xử lý filter buttons (Phim Bộ, Phim Lẻ trong dropdown)
  document.querySelectorAll(".filter-btn").forEach((btn) => {
    btn.addEventListener("click", handleFilterClick);
  });

  // Hàm xử lý click navigation
  function handleNavClick(e) {
    const page = e.currentTarget.dataset.page;

    if (!page && e.currentTarget.getAttribute('href') === '/index.html') {
      return; // Cho phép chuyển hướng mặc định của thẻ <a>
    }

    // Nếu không có data-page (các link có dropdown), không làm gì
    if (!page) {
      e.preventDefault();
      return;
    }

    e.preventDefault();

    // Remove active từ tất cả links
    document.querySelectorAll(".nav-link-custom, .mobile-nav-link").forEach((l) => {
      l.classList.remove("active");
    });

    // Add active cho link được click
    e.currentTarget.classList.add("active");

    // Chuyển hướng dựa trên page
    if (page === "category") {
      window.location.href = `/categorize-movie.html?type=${page}`;
    } else {
      // Dispatch custom event để filter.js xử lý (cho index.html)
      const event = new CustomEvent("navigationClick", {
        detail: { page: page },
      });
      window.dispatchEvent(event);
    }
  }

  // Hàm xử lý click filter (Phim Bộ, Phim Lẻ)
  function handleFilterClick(e) {
    e.preventDefault();
    const filter = e.currentTarget.dataset.filter;

    // Nếu đang ở index.html, dispatch event
    const currentPath = window.location.pathname;
    if (currentPath === "/index.html" || currentPath === "/") {
      const event = new CustomEvent("navigationClick", {
        detail: { page: filter },
      });
      window.dispatchEvent(event);
    }
  }

  // Highlight active page khi load
  document.addEventListener("DOMContentLoaded", () => {
    const currentPath = window.location.pathname;
    if (currentPath === "/index.html" || currentPath === "/") {
      document.querySelectorAll('[href="/index.html"]').forEach((link) => {
        link.classList.add("active");
      });
    }
  });


  // ================= USER / AVATAR / DROPDOWN / LOGOUT  =================
  (function () {
    const USER_KEY = "vitaflix_current_user";


    const displayUsernameSpan = document.querySelector("#displayUsername");
    const userWrapper = document.querySelector(".user-profile-wrapper");
    const authButtons = document.querySelector(".auth-buttons");
    const headerAvatar = document.querySelector("#headerAvatar");
    const defaultIcon = document.querySelector("#defaultUserIcon");
    const dropdown = document.querySelector("#userInfoDropdown");
    const dropdownAvatar = document.querySelector("#dropdownAvatar");
    const dropdownDefaultIconInDropdown = document.querySelector("#dropdownDefaultIconInDropdown");

    function updateUserUI() {
      let user = null;
      try {
        user = JSON.parse(localStorage.getItem(USER_KEY));
      } catch (e) {
        user = null;
      }

      if (user && user.username) {
        if (displayUsernameSpan) displayUsernameSpan.textContent = user.username;

        if (userWrapper) userWrapper.style.display = "";

        if (authButtons) authButtons.style.display = "none";

        const hasAvatar = user.avatar && user.avatar.trim() !== "";
        if (hasAvatar) {
          // Cập nhật ICON NGOÀI HEADER 
          if (headerAvatar) {
            headerAvatar.src = user.avatar;
            headerAvatar.classList.remove("d-none");
          }
          if (defaultIcon) defaultIcon.classList.add("d-none");

          // Cập nhật ICON TRONG DROPDOWN 
          if (dropdownAvatar) {
            dropdownAvatar.src = user.avatar;
            dropdownAvatar.classList.remove("d-none"); 
          }
          if (dropdownDefaultIconInDropdown) dropdownDefaultIconInDropdown.classList.add("d-none");

        } else {
          // Cập nhật ICON NGOÀI HEADER 
          if (defaultIcon) defaultIcon.classList.remove("d-none");
          if (headerAvatar) headerAvatar.classList.add("d-none");

          // Cập nhật ICON TRONG DROPDOWN 
          if (dropdownAvatar) dropdownAvatar.classList.add("d-none");
          if (dropdownDefaultIconInDropdown) dropdownDefaultIconInDropdown.classList.remove("d-none");
        }
      } else {
        if (displayUsernameSpan) displayUsernameSpan.textContent = "Khách";
        if (userWrapper) userWrapper.style.display = "none";
        if (defaultIcon) defaultIcon.classList.remove("d-none");
        if (headerAvatar) headerAvatar.classList.add("d-none");
        if (authButtons) authButtons.style.display = ""; 

        // Cập nhật ICON TRONG DROPDOWN 
        if (dropdownAvatar) dropdownAvatar.classList.add("d-none");
        if (dropdownDefaultIconInDropdown) dropdownDefaultIconInDropdown.classList.remove("d-none");
      }
    }

    window.addEventListener("load", updateUserUI); 

    window.addEventListener("storage", function (e) {
    const USER_KEY = 'vitaflix_current_user'; 
    if (e.key === USER_KEY) updateUserUI();
});

    // ================= DROPDOWN TOGGLE  =================
    document.addEventListener("click", function (e) {
      // nếu không có dropdown trong DOM thì bỏ qua
      if (!dropdown) return;

      const clickedIcon = e.target.closest("#userProfileIcon");

      if (clickedIcon) {
        e.stopPropagation();
        const currentUser = localStorage.getItem(USER_KEY);
        if (!currentUser) return;

        dropdown.classList.toggle("active");

        if (dropdown.classList.contains("active")) {
          dropdown.style.display = "block";
        } else {
          dropdown.style.display = "none";
        }
        return;
      }

      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove("active");
        dropdown.style.display = "none";
      }
    });

    // ================= LOGOUT =================
    document.addEventListener("click", function (e) {
      const logoutBtn = e.target.closest("#logoutBtn");
      if (!logoutBtn) return;

      localStorage.removeItem(USER_KEY);

      window.location.href = "/auth/login.html";
    });

    window.vitaUI = {
      refresh: updateUserUI
    };
  })();


</script>


<script type="module">
  import { searchMovies } from './js/modules/api.js';

  let searchTimeout;

  // Chờ một chút để đảm bảo DOM đã sẵn sàng
  setTimeout(() => {
    const searchInput = document.querySelector('#searchInput');
    const searchResults = document.querySelector('#searchResults');
    const searchResultsContent = document.querySelector('.search-results-content');

    console.log('Search initialized:', { searchInput, searchResults, searchResultsContent });

    if (searchInput && searchResults && searchResultsContent) {
      // Xử lý tìm kiếm
      searchInput.addEventListener('input', (e) => {
        const keyword = e.target.value.trim();

        clearTimeout(searchTimeout);

        if (keyword.length < 2) {
          searchResults.style.display = 'none';
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            searchResultsContent.innerHTML = '<div class="text-center p-3 text-white"><i class="fa-solid fa-spinner fa-spin"></i> Đang tìm...</div>';
            searchResults.style.display = 'block';

            const results = await searchMovies(keyword, 10);

            if (results.length === 0) {
              searchResultsContent.innerHTML = '<div class="search-no-results">Không tìm thấy phim nào</div>';
            } else {
              renderSearchResults(results);
            }
          } catch (error) {
            console.error('Search error:', error);
            searchResultsContent.innerHTML = '<div class="search-no-results">Đã xảy ra lỗi: ' + error.message + '</div>';
          }
        }, 500);
      });

      // Đóng dropdown khi click bên ngoài
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-box')) {
          searchResults.style.display = 'none';
        }
      });

      // Giữ dropdown mở khi click vào nó
      searchResults.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    } else {
      console.error('Không tìm thấy search elements!');
    }

    function renderSearchResults(movies) {
      let html = '';

      movies.forEach(movie => {
        const imageUrl = movie.thumb_url
          ? `https://phimimg.com/${movie.thumb_url}`
          : '/assets/images/default-poster.jpg';

        const movieType = movie.type === 'series' ? 'Phim bộ' :
          movie.type === 'single' ? 'Phim lẻ' :
            movie.type === 'hoathinh' ? 'Hoạt hình' : 'Phim';

        html += `
                <a href="/movie-info.html?slug=${movie.slug}" class="search-result-item">
                    <img src="${imageUrl}" alt="${movie.name}" class="search-result-thumb" 
                         onerror="this.src='/assets/images/default-poster.jpg'">
                    <div class="search-result-info">
                        <div class="search-result-title">${movie.name}</div>
                        <div class="search-result-meta">
                            ${movie.year || 'N/A'} • ${movieType}
                        </div>
                    </div>
                </a>
            `;
      });

      searchResultsContent.innerHTML = html;
    }
  }, 500); 
</script>